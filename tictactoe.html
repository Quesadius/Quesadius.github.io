<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tic-Tac-Toe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Paste your Firebase config object here to run this on your own site.
        // If left as null, the game will try to use the placeholder variables from this environment.
        // const YOUR_FIREBASE_CONFIG = null; // e.g., { apiKey: "...", authDomain: "...", ... };
        const YOUR_FIREBASE_CONFIG = {
    apiKey: "AIzaSyBhP0eTmmHB2LNh4nIaOZtTk7f1pBbPvgI",
    authDomain: "tictactoe-76547.firebaseapp.com",
    projectId: "tictactoe-76547",
    storageBucket: "tictactoe-76547.firebasestorage.app",
    messagingSenderId: "46072501212",
    appId: "1:46072501212:web:f427fe7d366a9feccd7519",
    measurementId: "G-BDP38SG25L"
  };
        
// <script type="module">
//   // Import the functions you need from the SDKs you need
//   import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
//   import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
//   // TODO: Add SDKs for Firebase products that you want to use
//   // https://firebase.google.com/docs/web/setup#available-libraries

//   // Your web app's Firebase configuration
//   // For Firebase JS SDK v7.20.0 and later, measurementId is optional
//   const firebaseConfig = {
//     apiKey: "AIzaSyBhP0eTmmHB2LNh4nIaOZtTk7f1pBbPvgI",
//     authDomain: "tictactoe-76547.firebaseapp.com",
//     projectId: "tictactoe-76547",
//     storageBucket: "tictactoe-76547.firebasestorage.app",
//     messagingSenderId: "46072501212",
//     appId: "1:46072501212:web:f427fe7d366a9feccd7519",
//     measurementId: "G-BDP38SG25L"
//   };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>


        let firebaseConfig;
        let appId;
        if (YOUR_FIREBASE_CONFIG) {
            firebaseConfig = YOUR_FIREBASE_CONFIG;
            appId = "tic-tac-toe-game"; // A unique ID for your app
        } else {
            // These variables are automatically provided in the collaborative environment
            firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        }

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        const gameId = 'main-game'; // Identifier for this game instance

        const boardElement = document.getElementById('board');
        const statusTextElement = document.getElementById('status-text');
        const authIdElement = document.getElementById('auth-id');
        const resetBtn = document.getElementById('reset-btn');
        const messageBox = document.getElementById('message-box');
        const messageContent = document.getElementById('message-content');
        const closeMessageBtn = document.getElementById('close-message');

        let board = ['', '', '', '', '', '', '', '', ''];
        let currentPlayer = 'X';
        let isGameActive = true;

        document.addEventListener('DOMContentLoaded', () => {
            if (Object.keys(firebaseConfig).length > 0) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        await signInAnonymously(auth);
                        userId = auth.currentUser.uid;
                    }
                    authIdElement.textContent = userId;
                    isAuthReady = true;
                    // Start listening for game state changes only after authentication is ready
                    setupGameListener();
                });
            } else {
                statusTextElement.textContent = 'Firebase configuration is missing.';
                showMessage('Error: Firebase configuration is missing. Please provide your own config to deploy this game outside of this environment.');
                console.error('Firebase configuration object is empty or not provided.');
            }

            resetBtn.addEventListener('click', resetGame);
            boardElement.addEventListener('click', handleCellClick);
            closeMessageBtn.addEventListener('click', () => messageBox.classList.add('hidden'));
        });

        function showMessage(text) {
            messageContent.textContent = text;
            messageBox.classList.remove('hidden');
        }

        function updateUI() {
            boardElement.innerHTML = '';
            board.forEach((cell, index) => {
                const cellDiv = document.createElement('div');
                cellDiv.className = `w-24 h-24 bg-white flex items-center justify-center text-4xl font-bold cursor-pointer rounded-lg shadow-md transition-all duration-200 hover:bg-gray-200 ${cell === 'X' ? 'text-blue-600' : (cell === 'O' ? 'text-red-600' : '')}`;
                cellDiv.dataset.index = index;
                cellDiv.textContent = cell;
                boardElement.appendChild(cellDiv);
            });
            statusTextElement.textContent = isGameActive ? `Current Player: ${currentPlayer}` : 'Game Over';
        }

        async function updateGameInFirestore() {
            if (!isAuthReady) return;
            try {
                const gameDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
                await setDoc(gameDocRef, {
                    board: JSON.stringify(board),
                    currentPlayer: currentPlayer,
                    isGameActive: isGameActive,
                    lastUpdated: Date.now()
                });
            } catch (e) {
                console.error("Error updating document: ", e);
            }
        }

        async function resetGame() {
            if (!isAuthReady) {
                showMessage('Please wait for authentication to be ready.');
                return;
            }
            board = ['', '', '', '', '', '', '', '', ''];
            currentPlayer = 'X';
            isGameActive = true;
            await updateGameInFirestore();
            updateUI();
            showMessage('Game reset!');
        }

        async function handleCellClick(e) {
            const index = e.target.dataset.index;
            if (!isGameActive || board[index] !== '') {
                return;
            }
            board[index] = currentPlayer;
            const winner = checkWinner();
            if (winner) {
                isGameActive = false;
                showMessage(`${winner} wins!`);
            } else if (board.every(cell => cell !== '')) {
                isGameActive = false;
                showMessage("It's a draw!");
            } else {
                currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
            }
            await updateGameInFirestore();
            updateUI();
        }

        function checkWinner() {
            const winningCombos = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8],
                [0, 3, 6], [1, 4, 7], [2, 5, 8],
                [0, 4, 8], [2, 4, 6]
            ];
            for (const combo of winningCombos) {
                const [a, b, c] = combo;
                if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                    return board[a];
                }
            }
            return null;
        }

        function setupGameListener() {
            const gameDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
            onSnapshot(gameDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    board = JSON.parse(data.board);
                    currentPlayer = data.currentPlayer;
                    isGameActive = data.isGameActive;
                    updateUI();
                } else {
                    resetGame(); // Initialize the game if the document doesn't exist
                }
            }, (error) => {
                console.error("Error getting real-time game state: ", error);
            });
        }
    </script>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4">
    <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">Tic-Tac-Toe</h1>
        <p id="status-text" class="text-center text-gray-500 mb-4 text-sm">Initializing...</p>
        <div class="text-center mb-6 p-3 bg-blue-100 rounded-lg shadow-inner">
            <p class="text-xs text-blue-500 break-all mt-1">
                Auth ID: <span id="auth-id" class="font-mono">Loading...</span>
            </p>
        </div>

        <div id="board" class="grid grid-cols-3 gap-2 p-2 bg-gray-300 rounded-lg">
            <!-- Board cells will be generated here -->
        </div>

        <div class="flex justify-center mt-6">
            <button id="reset-btn" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200">
                Reset Game
            </button>
        </div>
    </div>
    
    <!-- Custom Modal for Messages -->
    <div id="message-box" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-center">
            <p id="message-content" class="text-gray-800 text-lg font-medium mb-4"></p>
            <button id="close-message" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors duration-200">
                OK
            </button>
        </div>
    </div>
</body>
</html>
