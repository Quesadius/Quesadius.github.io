<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Tic-Tac-Toe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .game-board-grid {
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
        }

        .game-cell {
            aspect-ratio: 1/1;
            /* Makes the cells perfectly square */
            font-size: 3rem;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        .pulse-animation {
            animation: pulse 1.5s infinite ease-in-out;
        }
    </style>
</head>

<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4">

    <!-- Main Game Container -->
    <div id="app" class="bg-gray-800 rounded-2xl shadow-xl p-8 max-w-lg w-full flex flex-col items-center space-y-6">

        <!-- Header -->
        <h1 class="text-3xl font-bold text-center text-teal-400">Multiplayer Tic-Tac-Toe</h1>
        <p id="userIdDisplay" class="text-sm text-gray-400 font-mono text-center break-all">
            Loading user ID...
        </p>

        <!-- Game Info & Controls -->
        <div class="w-full space-y-4">
            <div id="gameStatus" class="text-center font-semibold text-xl">Loading...</div>

            <!-- Game Creation/Joining -->
            <div id="gameControls" class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                <input id="gameIdInput" type="text"
                    class="flex-grow p-3 rounded-lg bg-gray-700 text-white placeholder-gray-500 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-teal-400"
                    placeholder="Enter game ID to join">
                <button id="joinGameBtn"
                    class="w-full sm:w-auto px-6 py-3 bg-teal-500 text-white font-bold rounded-lg hover:bg-teal-600 transition-colors shadow-md">
                    Join Game
                </button>
            </div>
            <button id="createGameBtn"
                class="w-full px-6 py-3 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600 transition-colors shadow-md">
                Create New Game
            </button>
        </div>

        <!-- Game Board -->
        <div id="gameBoard"
            class="hidden w-full max-w-md bg-gray-700 rounded-xl shadow-inner p-2 grid game-board-grid border-4 border-gray-600">
            <!-- Cells will be generated here by JavaScript -->
        </div>

        <!-- Reset Button -->
        <button id="resetGameBtn"
            class="hidden w-full px-6 py-3 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 transition-colors shadow-md mt-4">
            Reset Game
        </button>

        <!-- Custom Modal -->
        <div id="messageModal" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-75 hidden">
            <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center">
                <p id="modalMessage" class="text-white text-lg font-semibold mb-4"></p>
                <button id="closeModalBtn"
                    class="px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600 transition-colors">OK</button>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs via CDN -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = '';
        let gameId = null;
        let currentPlayer = ''; // 'X' or 'O'
        let board = Array(9).fill(null);
        let playerSymbol = null; // 'X' or 'O' assigned to this user
        let opponentId = null;
        let gameListener = null;

        const boardElement = document.getElementById('gameBoard');
        const statusElement = document.getElementById('gameStatus');
        const userIdDisplayElement = document.getElementById('userIdDisplay');
        const createGameBtn = document.getElementById('createGameBtn');
        const joinGameBtn = document.getElementById('joinGameBtn');
        const gameIdInput = document.getElementById('gameIdInput');
        const gameControls = document.getElementById('gameControls');
        const resetGameBtn = document.getElementById('resetGameBtn');
        const messageModal = document.getElementById('messageModal');
        const modalMessage = document.getElementById('modalMessage');
        const closeModalBtn = document.getElementById('closeModalBtn');

        // Function to show the custom modal
        function showMessage(message) {
            modalMessage.textContent = message;
            messageModal.classList.remove('hidden');
        }

        // Function to hide the custom modal
        closeModalBtn.addEventListener('click', () => {
            messageModal.classList.add('hidden');
        });

        // Initialize Firebase and authenticate
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in with custom token if available, otherwise anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser.uid;
                userIdDisplayElement.textContent = `Your User ID: ${userId}`;
                console.log("Firebase initialized and authenticated successfully.");
                statusElement.textContent = 'Ready to play!';
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showMessage('Failed to connect to the database. Please check your network and try again.');
            }
        }

        // --- Game State Functions ---

        function checkWinner(currentBoard) {
            const lines = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], // Rows
                [0, 3, 6], [1, 4, 7], [2, 5, 8], // Columns
                [0, 4, 8], [2, 4, 6], // Diagonals
            ];
            for (let i = 0; i < lines.length; i++) {
                const [a, b, c] = lines[i];
                if (currentBoard[a] && currentBoard[a] === currentBoard[b] && currentBoard[a] === currentBoard[c]) {
                    return currentBoard[a]; // Returns 'X' or 'O'
                }
            }
            return null;
        }

        function isBoardFull(currentBoard) {
            return currentBoard.every(cell => cell !== null);
        }

        // --- UI Rendering ---

        function renderBoard() {
            boardElement.innerHTML = '';
            board.forEach((cell, index) => {
                const cellDiv = document.createElement('div');
                cellDiv.classList.add('game-cell', 'flex', 'items-center', 'justify-center', 'rounded-lg', 'bg-gray-800', 'text-white', 'cursor-pointer', 'select-none', 'transition-all', 'duration-200', 'hover:bg-gray-700', 'border', 'border-gray-600', 'shadow-md');
                cellDiv.textContent = cell;
                cellDiv.dataset.index = index;
                cellDiv.addEventListener('click', handleCellClick);
                boardElement.appendChild(cellDiv);
            });
        }

        function updateStatus() {
            if (gameId) {
                const winner = checkWinner(board);
                if (winner) {
                    statusElement.textContent = `Player ${winner} wins!`;
                    resetGameBtn.classList.remove('hidden');
                    return;
                }
                if (isBoardFull(board)) {
                    statusElement.textContent = 'It\'s a draw!';
                    resetGameBtn.classList.remove('hidden');
                    return;
                }
                
                const myTurn = (currentPlayer === playerSymbol);
                statusElement.textContent = myTurn ? `Your turn (${playerSymbol})` : `Opponent's turn (${currentPlayer})`;
                statusElement.classList.toggle('pulse-animation', myTurn);
            } else {
                statusElement.textContent = 'Create or join a game to start playing!';
            }
        }

        // --- Firestore Interaction ---

        async function createGame() {
            if (!userId) {
                showMessage("Authentication not ready. Please wait.");
                return;
            }

            const gamesCollection = collection(db, 'artifacts', appId, 'public', 'data', 'games');
            const newGameDocRef = await addDoc(gamesCollection, {
                players: { [userId]: 'X' },
                board: Array(9).fill(null),
                currentPlayer: 'X',
                status: 'waiting',
                created: new Date()
            });

            gameId = newGameDocRef.id;
            playerSymbol = 'X';
            showMessage(`Game created! Share this ID with a friend: ${gameId}`);
            subscribeToGame();
            
            gameControls.classList.add('hidden');
            boardElement.classList.remove('hidden');
        }

        async function joinGame() {
            const idToJoin = gameIdInput.value.trim();
            if (!idToJoin) {
                showMessage("Please enter a game ID.");
                return;
            }
            if (!userId) {
                showMessage("Authentication not ready. Please wait.");
                return;
            }

            const gameDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', idToJoin);
            const gameSnap = await getDoc(gameDocRef);

            if (!gameSnap.exists()) {
                showMessage('Game not found.');
                return;
            }

            const gameData = gameSnap.data();
            const players = gameData.players;

            if (Object.keys(players).length >= 2) {
                showMessage('This game is full.');
                return;
            }

            if (players[userId]) {
                // Rejoining a game
                gameId = idToJoin;
                playerSymbol = players[userId];
            } else {
                // Joining for the first time
                gameId = idToJoin;
                playerSymbol = 'O';
                await setDoc(gameDocRef, {
                    players: { ...players, [userId]: 'O' },
                    status: 'active'
                }, { merge: true });
            }

            showMessage(`Joined game ${gameId} as Player ${playerSymbol}!`);
            subscribeToGame();

            gameControls.classList.add('hidden');
            boardElement.classList.remove('hidden');
        }

        function subscribeToGame() {
            if (gameListener) {
                gameListener(); // Unsubscribe from previous game
            }
            const gameDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
            gameListener = onSnapshot(gameDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    board = data.board;
                    currentPlayer = data.currentPlayer;
                    
                    const players = Object.keys(data.players);
                    opponentId = players.find(id => id !== userId);

                    renderBoard();
                    updateStatus();
                } else {
                    console.log("Game no longer exists, resetting.");
                    resetGameState();
                    showMessage("The game has been deleted by the other player.");
                }
            }, (error) => {
                console.error("Error listening to game:", error);
            });
        }

        async function handleCellClick(event) {
            const index = parseInt(event.target.dataset.index, 10);
            const gameDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
            
            // Basic validation
            if (board[index] !== null || currentPlayer !== playerSymbol || checkWinner(board) || isBoardFull(board)) {
                return;
            }

            // Create a new board with the move
            const newBoard = [...board];
            newBoard[index] = playerSymbol;

            // Determine next player
            const newCurrentPlayer = playerSymbol === 'X' ? 'O' : 'X';

            // Update Firestore
            try {
                await setDoc(gameDocRef, {
                    board: newBoard,
                    currentPlayer: newCurrentPlayer
                }, { merge: true });
            } catch (error) {
                console.error("Error updating game state:", error);
                showMessage("Failed to make a move. Please try again.");
            }
        }
        
        async function resetGame() {
            if (!gameId) return;

            const gameDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
            
            try {
                 await setDoc(gameDocRef, {
                    board: Array(9).fill(null),
                    currentPlayer: 'X',
                    status: 'active'
                 }, { merge: true });
                 showMessage("Game has been reset!");
            } catch (error) {
                 console.error("Error resetting game:", error);
                 showMessage("Failed to reset the game. Please try again.");
            }
            resetGameBtn.classList.add('hidden');
        }
        
        function resetGameState() {
            if (gameListener) {
                gameListener();
            }
            gameId = null;
            currentPlayer = '';
            board = Array(9).fill(null);
            playerSymbol = null;
            opponentId = null;
            gameIdInput.value = '';
            gameControls.classList.remove('hidden');
            boardElement.classList.add('hidden');
            resetGameBtn.classList.add('hidden');
            updateStatus();
        }

        // Event listeners
        createGameBtn.addEventListener('click', createGame);
        joinGameBtn.addEventListener('click', joinGame);
        resetGameBtn.addEventListener('click', resetGame);

        // Run the main initialization function
        initializeFirebase();

    </script>
</body>
</html>
