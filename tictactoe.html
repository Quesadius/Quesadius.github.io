<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tic-Tac-Toe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Paste your Firebase config object here to run this on your own site.
        // If left as null, the game will try to use the placeholder variables from this environment.
        const YOUR_FIREBASE_CONFIG = {
            apiKey: "AIzaSyBhP0eTmmHB2LNh4nIaOZtTk7f1pBbPvgI",
            authDomain: "tictactoe-76547.firebaseapp.com",
            projectId: "tictactoe-76547",
            storageBucket: "tictactoe-76547.firebasestorage.app",
            messagingSenderId: "46072501212",
            appId: "1:46072501212:web:f427fe7d366a9feccd7519",
            measurementId: "G-BDP38SG25L"
        };
        
        let firebaseConfig;
        let appId;

        // Determine the Firebase configuration to use
        if (YOUR_FIREBASE_CONFIG && Object.keys(YOUR_FIREBASE_CONFIG).length > 0) {
            firebaseConfig = YOUR_FIREBASE_CONFIG;
            appId = YOUR_FIREBASE_CONFIG.projectId; 
        } else {
            firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        }

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let playerMark = null;

        const urlParams = new URLSearchParams(window.location.search);
        let gameId = urlParams.get('gameId');

        if (!gameId) {
            gameId = crypto.randomUUID();
            if (window.location.protocol !== 'blob:') {
                window.history.replaceState({}, '', `${window.location.pathname}?gameId=${gameId}`);
            }
        }

        const boardElement = document.getElementById('board');
        const statusTextElement = document.getElementById('status-text');
        const authIdElement = document.getElementById('auth-id');
        const resetBtn = document.getElementById('reset-btn');
        const shareBtn = document.getElementById('share-btn');
        const deleteBtn = document.getElementById('delete-btn');
        const messageBox = document.getElementById('message-box');
        const messageContent = document.getElementById('message-content');
        const closeMessageBtn = document.getElementById('close-message');
        const chooseMarkContainer = document.getElementById('choose-mark-container');
        const chooseXBtn = document.getElementById('choose-x-btn');
        const chooseOBtn = document.getElementById('choose-o-btn');

        let board = ['', '', '', '', '', '', '', '', ''];
        let currentPlayer = 'X';
        let isGameActive = true;
        let playerX = null;
        let playerO = null;

        document.addEventListener('DOMContentLoaded', () => {
            if (Object.keys(firebaseConfig).length === 0) {
                statusTextElement.textContent = 'Firebase configuration is missing.';
                showMessage('Error: Firebase configuration is missing. Please provide your own config to deploy this game outside of this environment.');
                console.error('Firebase configuration object is empty or not provided.');
                return;
            }
            
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                signInAnonymously(auth)
                    .then((userCredential) => {
                        userId = userCredential.user.uid;
                        authIdElement.textContent = userId;
                        isAuthReady = true;
                        console.log("Firebase initialized successfully. User ID:", userId);
                        setupGameListener();
                    })
                    .catch((error) => {
                        statusTextElement.textContent = 'Auth Error.';
                        showMessage(`Authentication Error: ${error.message}. Please check your Firebase project settings.`);
                        console.error("Authentication Error:", error);
                    });
            } catch (e) {
                statusTextElement.textContent = 'Error initializing Firebase.';
                showMessage(`Error initializing Firebase: ${e.message}. Check your configuration.`);
                console.error("Error initializing Firebase:", e);
            }

            resetBtn.addEventListener('click', resetGame);
            shareBtn.addEventListener('click', copyLink);
            deleteBtn.addEventListener('click', deleteGame);
            boardElement.addEventListener('click', handleCellClick);
            closeMessageBtn.addEventListener('click', () => messageBox.classList.add('hidden'));
            chooseXBtn.addEventListener('click', () => chooseMark('X'));
            chooseOBtn.addEventListener('click', () => chooseMark('O'));
        });

        function showMessage(text) {
            messageContent.textContent = text;
            messageBox.classList.remove('hidden');
        }

        async function copyLink() {
            try {
                const urlToCopy = window.location.href;
                await navigator.clipboard.writeText(urlToCopy);
                showMessage('Link copied to clipboard!');
            } catch (err) {
                showMessage('Failed to copy link. Your browser may not support this feature or you need to grant permission.');
                console.error('Could not copy URL: ', err);
            }
        }

        function updateUI() {
            boardElement.innerHTML = '';
            board.forEach((cell, index) => {
                const cellDiv = document.createElement('div');
                cellDiv.className = `w-24 h-24 bg-white flex items-center justify-center text-4xl font-bold cursor-pointer rounded-lg shadow-md transition-all duration-200 hover:bg-gray-200 ${cell === 'X' ? 'text-blue-600' : (cell === 'O' ? 'text-red-600' : '')}`;
                cellDiv.dataset.index = index;
                cellDiv.textContent = cell;
                boardElement.appendChild(cellDiv);
            });
            
            if (playerX === null && playerO === null) {
                chooseMarkContainer.classList.remove('hidden');
                boardElement.classList.add('hidden');
                statusTextElement.textContent = 'Choose your mark to begin.';
                return;
            } else {
                chooseMarkContainer.classList.add('hidden');
                boardElement.classList.remove('hidden');
            }

            let statusMessage = isGameActive ? `Current Player: ${currentPlayer}` : 'Game Over';
            if (isGameActive) {
                if (playerMark === currentPlayer) {
                    statusMessage = `It's your turn (${playerMark})`;
                } else {
                    statusMessage = `Waiting for ${currentPlayer} to move...`;
                }
            }
            statusTextElement.textContent = statusMessage;
        }

        async function updateGameInFirestore() {
            if (!isAuthReady) return;
            try {
                const gameDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
                await setDoc(gameDocRef, {
                    board: JSON.stringify(board),
                    currentPlayer: currentPlayer,
                    isGameActive: isGameActive,
                    playerX: playerX,
                    playerO: playerO,
                    lastUpdated: Date.now()
                });
            } catch (e) {
                console.error("Error updating document: ", e);
            }
        }

        async function resetGame() {
            if (!isAuthReady) {
                showMessage('Please wait for authentication to be ready.');
                return;
            }
            board = ['', '', '', '', '', '', '', '', ''];
            currentPlayer = 'X';
            isGameActive = true;
            playerX = null;
            playerO = null;
            playerMark = null;
            await updateGameInFirestore();
        }

        async function chooseMark(mark) {
            if (!isAuthReady) {
                showMessage('Please wait for authentication to be ready.');
                return;
            }
            if (playerMark) {
                showMessage('You have already chosen your mark.');
                return;
            }

            const gameDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
            const docSnap = await getDoc(gameDocRef);
            
            if (mark === 'X') {
                if (docSnap.exists() && docSnap.data().playerX !== null) {
                    showMessage('Player X is already taken. Please refresh and try again.');
                    return;
                }
                playerX = userId;
                playerMark = 'X';
            } else if (mark === 'O') {
                if (docSnap.exists() && docSnap.data().playerO !== null) {
                    showMessage('Player O is already taken. Please refresh and try again.');
                    return;
                }
                playerO = userId;
                playerMark = 'O';
            }
            await updateGameInFirestore();
        }

        async function deleteGame() {
            if (!isAuthReady) {
                showMessage('Please wait for authentication to be ready.');
                return;
            }
            if (playerMark !== 'X' && playerMark !== 'O') {
                showMessage('Only active players can delete the game.');
                return;
            }
            try {
                const gameDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
                await deleteDoc(gameDocRef);
                showMessage('Game deleted! You can start a new one.');
                 if (window.location.protocol !== 'blob:') {
                    window.history.replaceState({}, '', window.location.pathname);
                }
            } catch (e) {
                showMessage('Error deleting game. Check your permissions.');
                console.error("Error deleting document: ", e);
            }
        }

        async function handleCellClick(e) {
            const index = e.target.dataset.index;
            if (playerMark !== currentPlayer) {
                showMessage("It's not your turn!");
                return;
            }
            if (!isGameActive || board[index] !== '') {
                return;
            }
            board[index] = currentPlayer;
            const winner = checkWinner();
            if (winner) {
                isGameActive = false;
                showMessage(`${winner} wins!`);
            } else if (board.every(cell => cell !== '')) {
                isGameActive = false;
                showMessage("It's a draw!");
            } else {
                currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
            }
            await updateGameInFirestore();
        }

        function checkWinner() {
            const winningCombos = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8],
                [0, 3, 6], [1, 4, 7], [2, 5, 8],
                [0, 4, 8], [2, 4, 6]
            ];
            for (const combo of winningCombos) {
                const [a, b, c] = combo;
                if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                    return board[a];
                }
            }
            return null;
        }

        function setupGameListener() {
            const gameDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
            onSnapshot(gameDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    board = JSON.parse(data.board);
                    currentPlayer = data.currentPlayer;
                    isGameActive = data.isGameActive;
                    playerX = data.playerX;
                    playerO = data.playerO;

                    if (!playerMark && playerX === userId) {
                         playerMark = 'X';
                    }
                    if (!playerMark && playerO === userId) {
                         playerMark = 'O';
                    }
                    
                    updateUI();
                } else {
                    resetGame();
                }
            }, (error) => {
                console.error("Error getting real-time game state: ", error);
            });
        }
    </script>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4">
    <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">Tic-Tac-Toe</h1>
        <p id="status-text" class="text-center text-gray-500 mb-4 text-sm">Initializing...</p>
        <div class="text-center mb-6 p-3 bg-blue-100 rounded-lg shadow-inner">
            <p class="text-xs text-blue-500 break-all mt-1">
                Auth ID: <span id="auth-id" class="font-mono">Loading...</span>
            </p>
        </div>

        <div id="choose-mark-container" class="flex justify-center mt-4 space-x-4 hidden">
            <button id="choose-x-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200">
                Play as X
            </button>
            <button id="choose-o-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-700 transition-colors duration-200">
                Play as O
            </button>
        </div>

        <div id="board" class="grid grid-cols-3 gap-2 p-2 bg-gray-300 rounded-lg">
            <!-- Board cells will be generated here -->
        </div>

        <div class="flex justify-center mt-6 space-x-4">
            <button id="reset-btn" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200">
                Reset Game
            </button>
             <button id="share-btn" class="bg-green-500 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-green-600 transition-colors duration-200">
                Copy Link
            </button>
             <button id="delete-btn" class="bg-red-500 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-red-600 transition-colors duration-200">
                Delete Game
            </button>
        </div>
    </div>
    
    <!-- Custom Modal for Messages -->
    <div id="message-box" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-center">
            <p id="message-content" class="text-gray-800 text-lg text-lg font-medium mb-4"></p>
            <button id="close-message" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors duration-200">
                OK
            </button>
        </div>
    </div>
</body>
</html>
